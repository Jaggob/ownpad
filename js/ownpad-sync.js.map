{"version":3,"file":"ownpad-sync.js?v=dff76d5f78e33a6f92aa","mappings":"AAAA,MACE,MAAMA,EAAOC,SAASC,gBAChBC,EAAOH,GAAMI,SAASC,WACtBC,EAAUN,GAAMI,SAASG,cACzBC,EAAkBC,KAAKC,IAAI,GAAIC,SAASX,GAAMI,SAASQ,oBAAsB,MAAO,KAC1F,IAAKT,IAASG,EACZ,OAGF,MAeMO,EAfkBC,MACtB,GAAIC,OAAOC,GAAI,CACb,GAAkC,mBAAvBA,GAAGF,gBACZ,OAAOE,GAAGF,kBAEZ,GAAIE,GAAGH,aACL,OAAOG,GAAGH,YAEd,CACA,OAAIE,OAAOE,gBACFF,OAAOE,gBAEThB,SAASiB,cAAc,8BAA8BC,aAAa,YAAc,EAAE,EAGtEL,GACrB,IAAKD,EACH,OAGF,MAAMO,EAAgBA,KACpB,MAAMC,EAAO,IAAIC,gBAGjB,OAFAD,EAAKE,IAAI,OAAQpB,GACjBkB,EAAKE,IAAI,eAAgBV,GAClBQ,EAAKG,UAAU,EAGlBC,EAAUA,KACdC,MAAMpB,EAAS,CACbqB,OAAQ,OACRC,YAAa,cACbC,QAAS,CACP,eAAgB,oCAChB,aAAgBhB,EAChB,mBAAoB,kBAEtBQ,KAAMD,MACLU,OAAM,QAEP,EAGEC,EAAeA,KACnB,IAAKC,UAAUC,WAEb,YADAR,IAGF,MAAMS,EAAO,IAAIC,SACjBD,EAAKE,OAAO,OAAQjC,GACpB+B,EAAKE,OAAO,eAAgBvB,GAC5BmB,UAAUC,WAAW3B,EAAS4B,EAAK,EAGrCT,IACA,MAAMY,EAAQC,YAAYb,EAA2B,IAAlBjB,GAEnCP,SAASsC,iBAAiB,oBAAoB,KACX,WAA7BtC,SAASuC,iBACXT,GACF,IAGFhB,OAAOwB,iBAAiB,eAAgBR,GACxChB,OAAOwB,iBAAiB,SAAUR,GAClChB,OAAOwB,iBAAiB,WAAYR,GACpChB,OAAOwB,iBAAiB,YAAY,KAClCE,cAAcJ,GACdN,GAAc,IAGhB,MAAMW,EAAQzC,SAAS0C,eAAe,gBACtC,GAAID,EAAO,CACT,MAAME,EAAW,IAAIC,kBAAiB,KAC/B5C,SAASoB,KAAKyB,SAASJ,KAC1BE,EAASG,aACThB,IACF,IAEFa,EAASI,QAAQ/C,SAASoB,KAAM,CAAE4B,WAAW,EAAMC,SAAS,GAC9D,CACD,EAzFD","sources":["webpack:///ownpad/src/sync.js"],"sourcesContent":["(() => {\n  const root = document.documentElement;\n  const file = root?.dataset?.ownpadFile;\n  const syncUrl = root?.dataset?.ownpadSyncUrl;\n  const intervalSeconds = Math.max(30, parseInt(root?.dataset?.ownpadSyncInterval || '120', 10));\n  if (!file || !syncUrl) {\n    return;\n  }\n\n  const getRequestToken = () => {\n    if (window.OC) {\n      if (typeof OC.getRequestToken === 'function') {\n        return OC.getRequestToken();\n      }\n      if (OC.requestToken) {\n        return OC.requestToken;\n      }\n    }\n    if (window.oc_requesttoken) {\n      return window.oc_requesttoken;\n    }\n    return document.querySelector('meta[name=\"requesttoken\"]')?.getAttribute('content') || '';\n  };\n\n  const requestToken = getRequestToken();\n  if (!requestToken) {\n    return;\n  }\n\n  const buildFormBody = () => {\n    const body = new URLSearchParams();\n    body.set('file', file);\n    body.set('requesttoken', requestToken);\n    return body.toString();\n  };\n\n  const syncNow = () => {\n    fetch(syncUrl, {\n      method: 'POST',\n      credentials: 'same-origin',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded',\n        'requesttoken': requestToken,\n        'X-Requested-With': 'XMLHttpRequest',\n      },\n      body: buildFormBody(),\n    }).catch(() => {\n      // Ignore network errors; next interval will retry.\n    });\n  };\n\n  const syncOnUnload = () => {\n    if (!navigator.sendBeacon) {\n      syncNow();\n      return;\n    }\n    const data = new FormData();\n    data.append('file', file);\n    data.append('requesttoken', requestToken);\n    navigator.sendBeacon(syncUrl, data);\n  };\n\n  syncNow();\n  const timer = setInterval(syncNow, intervalSeconds * 1000);\n\n  document.addEventListener('visibilitychange', () => {\n    if (document.visibilityState === 'hidden') {\n      syncOnUnload();\n    }\n  });\n\n  window.addEventListener('beforeunload', syncOnUnload);\n  window.addEventListener('unload', syncOnUnload);\n  window.addEventListener('popstate', syncOnUnload);\n  window.addEventListener('pagehide', () => {\n    clearInterval(timer);\n    syncOnUnload();\n  });\n\n  const frame = document.getElementById('ownpad_frame');\n  if (frame) {\n    const observer = new MutationObserver(() => {\n      if (!document.body.contains(frame)) {\n        observer.disconnect();\n        syncOnUnload();\n      }\n    });\n    observer.observe(document.body, { childList: true, subtree: true });\n  }\n})();\n"],"names":["root","document","documentElement","file","dataset","ownpadFile","syncUrl","ownpadSyncUrl","intervalSeconds","Math","max","parseInt","ownpadSyncInterval","requestToken","getRequestToken","window","OC","oc_requesttoken","querySelector","getAttribute","buildFormBody","body","URLSearchParams","set","toString","syncNow","fetch","method","credentials","headers","catch","syncOnUnload","navigator","sendBeacon","data","FormData","append","timer","setInterval","addEventListener","visibilityState","clearInterval","frame","getElementById","observer","MutationObserver","contains","disconnect","observe","childList","subtree"],"sourceRoot":""}